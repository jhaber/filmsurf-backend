var Movies = require('./movies');

exports.bind = function(router) {
    router.get('/movie/:id', function (req, res) {
        var id = req.params.id;
        Movies.retrieve(id, function(data, expiration) {
            respond(res, data, expiration);
        });
    });

    router.get('/search', function (req, res) {
        Movies.search(req.query).spread(succeed(res)).fail(fail(res)).done();
    });
};

function succeed(res) {
    return function(data, expiration) {
        res.setHeader('Cache-Control', 'max-age=' + expiration + ', public');
        res.json(data);
    }
}

function fail(res) {
    return function(code) {
        res.send(code);
    }
}

var respond = function(res, data, expiration) {
    if (expiration) {
        res.setHeader('Cache-Control', 'max-age=' + expiration + ', public');
    }
    if (data.error === true) {
        res.send(data.code);
    } else {
        res.json(data);
    }
};