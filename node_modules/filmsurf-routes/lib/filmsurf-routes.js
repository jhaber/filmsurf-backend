var Movies = require('./movies');
var Ebert = require('./ebert');

exports.bind = function(router) {
    router.get('/movie/:id', function (req, res) {
        var id = req.params.id;
        handle(Movies.retrieve(id), res);
    });

    router.get('/search', function (req, res) {
        handle(Movies.search(req.query), res);
    });
};

exports.ebert = function() {
    Ebert.test();
};

function handle(promise, res) {
    promise.spread(succeed(res)).fail(fail(res)).done();
}

function succeed(res) {
    return function(data, expiration) {
        res.setHeader('Cache-Control', 'max-age=' + expiration + ', public');
        res.json(data);
    }
}

function fail(res) {
    return function(code) {
        res.send(code);
    }
}