var RottenTomatoes = require('./rottentomatoes');
var IMDb = require('./imdb');
var Cache = require('./cache');

var MovieCache = Cache.functions.movies;
var SearchCache = Cache.functions.search;

exports.retrieve = function(id, callback) {
    MovieCache.retrieve(id, function(data) {
        if (data) {
            callback(data);
        } else {
            RottenTomatoes.retrieve(id, function(data) {
                if (data) {
                    var response = {};
                    response.rotten_tomatoes = data;

                    if (data.alternate_ids && data.alternate_ids.imdb) {
                        var imdbId = 'tt' + data.alternate_ids.imdb;

                        IMDb.retrieve(imdbId, function(imdbData) {
                            if (imdbData) {
                                response.imdb = imdbData;
                            }
                            callback(response);
                            MovieCache.save(id, response);
                        });
                    } else {
                        callback(response);
                        MovieCache.save(id, response);
                    }
                } else {
                    callback(undefined);
                }
            });
        }
    });
};

exports.search = function(params, callback) {
    var query = params.q;

    if (!query) {
        callback(undefined);
        return;
    }

    var page;
    var items;
    if (params.live && params.live.toLowerCase() === 'true') {
        page = 0;
        items = 5;
    } else {
        page = params.page ? Number(params.page) : 0;
        items = 50;
    }

    var cacheKey = { 'query': query, 'page': page, 'items': items };

    SearchCache.retrieve(cacheKey, function(data) {
        if (data) {
            callback(data);
        } else {
            RottenTomatoes.search(query, page, items, function(data) {
                callback(data);
                SearchCache.save(cacheKey, data);
            });
        }
    });
};

exports.evict = function() {
    Cache.emitter.once('ready', function() {
        MovieCache.evict();
        SearchCache.evict();
    });

    Cache.emitter.once('done', function() {
        process.exit();
    });

    setTimeout(function() {
        process.exit();
    }, 60000)
};