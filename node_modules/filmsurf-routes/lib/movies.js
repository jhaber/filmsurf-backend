var RottenTomatoes = require('./rottentomatoes');
var IMDb = require('./imdb');
var Cache = require('./cache');

exports.retrieve = function(id, callback) {
    var cacheKey = ['movies', id];

    //Cache.retrieve(cacheKey).spread(function(data, expiration) {
    Cache.retrieve(cacheKey).then(function(data) {
        callback(data, 604800);
    }, function() {
        RottenTomatoes.retrieve(id, function(data, expiration) {
            if (data.error === true) {
                callback(data, expiration);
            } else {
                var response = {};
                response.rotten_tomatoes = data;

                if (data.alternate_ids && data.alternate_ids.imdb) {
                    var imdbId = 'tt' + data.alternate_ids.imdb;

                    IMDb.retrieve(imdbId, function(imdbData) {
                        if (imdbData) {
                            response.imdb = imdbData;
                        }
                        callback(response, expiration);
                        Cache.save(cacheKey, response, expiration);
                    });
                } else {
                    callback(response, expiration);
                    Cache.save(cacheKey, response, expiration);
                }
            }
        });
    });
};

exports.search = function(params, callback) {
    var query = params.q;
    var page = params.page ? parseInt(params.page) : 0;

    if (!query) {
        callback(undefined);
        return;
    }

    var cacheKey = ['search', query, page];

    //Cache.retrieve(cacheKey).spread(function(data, expiration) {
    Cache.retrieve(cacheKey).then(function(data) {
        callback(data, 604800);
    }, function() {
        RottenTomatoes.search(query, page, function(data, expiration) {
            callback(data, expiration);
            if (data.error !== true) {
                Cache.save(cacheKey, data, expiration);
            }
        });
    });
};