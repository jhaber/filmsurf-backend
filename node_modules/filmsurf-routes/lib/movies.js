var RottenTomatoes = require('./rottentomatoes');
var IMDb = require('./imdb');
var Cache = require('./cache');

exports.retrieve = function(id, callback) {
    Cache.movies.retrieve(id, function(data) {
        if (data) {
            callback(data);
        } else {
            RottenTomatoes.retrieve(id, function(data) {
                if (data) {
                    var response = {};
                    response.rotten_tomatoes = data;

                    if (data.alternate_ids && data.alternate_ids.imdb) {
                        var imdbId = 'tt' + data.alternate_ids.imdb;

                        IMDb.retrieve(imdbId, function(imdbData) {
                            if (imdbData) {
                                response.imdb = imdbData;
                            }
                            callback(response);
                            Cache.movies.save(id, response);
                        });
                    } else {
                        callback(response);
                        Cache.movies.save(id, response);
                    }
                } else {
                    callback(undefined);
                }
            });
        }
    });
};

exports.search = function(params, callback) {
    var query = params.q;

    if (!query) {
        callback(undefined);
        return;
    }

    var page;
    var items;
    if (params.live && params.live.toLowerCase() === 'true') {
        page = 0;
        items = 5;
    } else {
        page = params.page ? Number(params.page) : 0;
        items = 50;
    }

    var cacheKey = { 'query': query, 'page': page, 'items': items };

    Cache.search.retrieve(cacheKey, function(data) {
        if (data) {
            callback(data);
        } else {
            RottenTomatoes.search(query, page, items, function(data) {
                callback(data);
                Cache.search.save(cacheKey, data);
            });
        }
    });
}