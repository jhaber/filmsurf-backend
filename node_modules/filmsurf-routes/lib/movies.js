var RottenTomatoes = require('./rottentomatoes');
var IMDb = require('./imdb');
var Cache = require('./cache');

exports.retrieve = function(id, callback) {
    Cache.movies.retrieve(id, function(data) {
        if (data) {
            callback(data);
        } else {
            RottenTomatoes.retrieve(id, function(data) {
                if (data) {
                    var response = {};
                    response.rotten_tomatoes = data;

                    if (data.alternate_ids && data.alternate_ids.imdb) {
                        var imdbId = 'tt' + data.alternate_ids.imdb;

                        IMDb.retrieve(imdbId, function(imdbData) {
                            if (imdbData) {
                                response.imdb = imdbData;
                            }
                            callback(response);
                            Cache.movies.save(id, response);
                        });
                    } else {
                        callback(response);
                        Cache.movies.save(id, response);
                    }
                } else {
                    callback(undefined);
                }
            });
        }
    });
};

exports.search = function(params, callback) {
    var query = params.q;
    var page = params.page ? Number(params.page) : 0;
    var items = params.items ? Number(params.items) : 10;
    var live = params.live && params.live.toLowerCase() === 'true';

    if (query) {
        if (live) {
            Cache.search.retrieve(query, function(data) {
                if (data) {
                    callback(data);
                } else {
                    RottenTomatoes.search(query, 0, 5, function(data) {
                        callback(data);
                        Cache.search.save(query, data);
                    });
                }
            });
        } else {
            RottenTomatoes.search(query, page, items, callback);
        }
    } else {
        callback(undefined);
    }
}