var Request = require('request');

var host = 'http://api.rottentomatoes.com';
var basePath = '/api/public/v1.0';

var searchPath = host + basePath + '/movies.json';

var apiKey = process.env.ROTTEN_TOMATOES_API_KEY;

console.log('Using Rotten Tomatoes API Key: ' + apiKey);

exports.retrieve = function (id, callback) {
    var retrievePath = host + basePath + '/movies/' + encodeURIComponent(id) + '.json';

    var request = {};
    request.url = retrievePath;
    request.qs = { 'apikey': apiKey };
    request.json = true;

    Request.get(request, function (error, response, body) {
        if (!error && response && response.statusCode === 200) {
            callback(body);
        } else {
            if (error) {
                console.log('Error retrieving URL: ' + retrievePath + ', ' + error);
            }

            if (response && response.statusCode !== 200) {
                console.log('Status code retrieving URL: ' + retrievePath + ', ' + response.statusCode);
            }

            callback(undefined)
        }
    });
}

exports.search = function (query, page, items, callback) {
    var request = {};
    request.url = searchPath;
    request.qs = { 'q': query,
                   'page': page + 1,
                   'page_limit': items,
                   'apikey': apiKey };
    request.json = true;

    Request.get(request, function (error, response, body) {
        if (!error && response.statusCode === 200) {
            callback(body);
        } else {
            if (error) {
                console.log('Search error: ' + error);
            }

            if (response.statusCode !== 200) {
                console.log('Search status code: ' + response.statusCode);
            }

            callback({ error: true })
        }
    });
}