var EventEmitter = require('events').EventEmitter;
var MongoClient = require('mongodb').MongoClient;
require('date-utils');

module.exports = { emitter: new EventEmitter(), functions: {} };

var Movies = undefined;
var Search = undefined;

var ensureIndex = function (collection) {
    collection.ensureIndex({ id: 1 }, { unique: true, w: 1 }, function(err) {
        if (err) {
            console.log('Error ensuring index on ' + collection.collectionName +': ' + err);
        }
    });
};

console.log('Opening mongo connection to ' + process.env.MONGOLAB_URI);
MongoClient.connect(process.env.MONGOLAB_URI, function (err, db) {
    if (err) {
        console.log('Error connecting to mongo: ' + err);
    } else {
        console.log('Successfully connected to mongo');

        Movies = db.collection('movies');
        Search = db.collection('search');

        ensureIndex(Movies);
        ensureIndex(Search);
    }

    module.exports.emitter.emit('ready');
});

module.exports.functions.movies = {
    save: function (id, movie) {
        save(Movies, id, movie);
    },
    retrieve: function (id, callback) {
        retrieve(Movies, id, callback);

    },
    evict: function() {
        console.log('Starting to evict movies');
        findAll(Movies, function (wrapper) {
            var createDate = wrapper._id.getTimestamp();
            var releaseDates = undefined;
            if (wrapper && wrapper.data && wrapper.data.rotten_tomatoes) {
                releaseDates = wrapper.data.rotten_tomatoes.release_dates;
            }

            if (shouldEvictMovie(createDate, releaseDates)) {
               remove(Movies, wrapper);
            }
        });
    }
};

module.exports.functions.search = {
    save: function (query, results) {
        save(Search, query, results);
    },
    retrieve: function (query, callback) {
        retrieve(Search, query, callback);
    },
    evict: function() {
        console.log('Starting to evict searches');
        findAll(Search, function (wrapper) {
            var createDate = wrapper._id.getTimestamp();

            if (shouldEvictSearch(createDate)) {
                remove(Search, wrapper);
            }
        });
    }
};

var save = function (collection, id, data) {
    if (!collection) return;

    var wrapper = { 'id': id, 'data': data };

    collection.findAndModify({ 'id': id }, [], wrapper, { upsert: true, w: 1, new: true }, function (err) {
        if (err) {
            console.log('Error persisting data: ' + err);
        }
    });
};

var retrieve = function (collection, id, callback) {
    if (!collection) callback(undefined);

    collection.findOne({ 'id': id }, function (err, wrapper) {
        if (err) {
            console.log('Error querying for data: ' + err);
            callback(undefined);
        }

        if (wrapper) {
            callback(wrapper.data);
        } else {
            callback(undefined);
        }
    });
};

var findAll = function (collection, callback) {
    if (!collection) return;

    collection.find({}, { snapshot: true, batchSize: 100 }).each(function(err, wrapper) {
        if (err) {
            console.log('Error while evicting ' + collection.collectionName + ': ' + err);
        } else if (wrapper) {
            callback(wrapper);
        }
    });
};

var remove = function (collection, wrapper) {
    collection.remove({ _id: wrapper._id }, { w: 1 }, function (err) {
        console.log('Error removing document ' + id + ' from collection ' + collection.collectionName + ': ' + err);
    });
};

var shouldEvictMovie = function(createDate, releaseDates) {
    var release = new Date().addYears(-5);
    if (releaseDates) {
        if (releaseDates.theater) {
            release = dateFromString(releaseDates.theater);
        } else if (releaseDates.dvd) {
            release = dateFromString(releaseDates.dvd);
        }
    }

    var movieAge = release.getDaysBetween(new Date());
    var entryAge = createDate.getDaysBetween(new Date());

    return entryAge > maxAge(movieAge);
};

var shouldEvictSearch = function(createDate) {
    var entryAge = createDate.getDaysBetween(new Date());

    return entryAge > 7;
};

var dateFromString = function(dateString) {
    var parts = dateString.split("-");
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
};

var maxAge = function(movieAge) {
    return Math.ceil(movieAge / 365);
};

