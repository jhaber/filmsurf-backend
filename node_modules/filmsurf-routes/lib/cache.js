var Url = require('url');
var Redis = require('redis');

var connect = function(connectString) {
    console.log('Opening Redis connection to ' + connectString);
    var redisUrl = Url.parse(connectString);
    var client = Redis.createClient(redisUrl.port, redisUrl.hostname, {no_ready_check: true});
    client.auth(redisUrl.auth.split(":")[1]);
    return client;
};

var client = connect(process.env.REDISCLOUD_URL);
var cache = client;

client.on('connect', function() {
    cache = client;
    console.log('Successfully connected to Redis');
});

client.on('error', function() {
    cache = undefined;
    console.log('Error connecting to Redis');
});

client.on('end', function() {
    cache = undefined;
    console.log('Connection to Redis ended');
});

exports.save = function(keyArray, value, expiration) {
    if (!cache) return;

    var key = keyArray.join(':');

    cache.set(key, JSON.stringify(value), function(err) {
        if (err) {
            console.log('Error setting key ' + key + ': ' + err);
        } else {
            cache.expire(key, expiration);
        }
    });
};

exports.retrieve = function(keyArray, callback) {
    if (!cache) callback(undefined);

    var key = keyArray.join(':');

    cache.get(key, function(err, data) {
        if (err) {
            console.log('Error getting key ' + key + ': ' + err);
            callback(undefined);
        } else if (data) {
            callback(JSON.parse(data));
        } else {
            callback(undefined);
        }
    });
};
