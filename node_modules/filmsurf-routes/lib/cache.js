var MongoClient = require('mongodb').MongoClient;

var Movies = undefined;
var Search = undefined;

var ensureIndex = function (collection) {
    collection.ensureIndex({ id: 1 }, { unique: true, w: 1 }, function(err) {
        if (err) {
            console.log('Error ensuring index on ' + collection.collectionName +': ' + err);
        }
    });
};

console.log('Opening mongo connection to ' + process.env.MONGOLAB_URI);
MongoClient.connect(process.env.MONGOLAB_URI, function (err, db) {
    if (err) {
        console.log('Error connecting to mongo: ' + err);
    } else {
        Movies = db.collection('movies');
        Search = db.collection('search');

        ensureIndex(Movies);
        ensureIndex(Search);
    }
});

exports.movies = {};
exports.search = {};

exports.movies.save = function (id, movie) {
    save(Movies, id, movie);
};

exports.movies.retrieve = function (id, callback) {
    retrieve(Movies, id, callback);
};

exports.search.save = function (query, results) {
    save(Search, query, results);
};

exports.search.retrieve = function (query, callback) {
    retrieve(Search, query, callback);
};

var save = function (collection, id, data) {
    if (!collection) return;

    var wrapper = { 'id': id, 'data': data };

    collection.findAndModify({ 'id': id }, [], wrapper, { upsert: true, w: 1, new: true }, function (err) {
        if (err) {
            console.log('Error persisting data: ' + err);
        }
    });
};

var retrieve = function (collection, id, callback) {
    if (!collection) callback(undefined);

    collection.findOne({ 'id': id }, function (err, wrapper) {
        if (err) {
            console.log('Error querying for data: ' + err);
            callback(undefined);
        }

        if (wrapper) {
            callback(wrapper.data);
        } else {
            callback(undefined);
        }
    });
};

