var Mongo = require('mongo-lite');

console.log('Opening mongo connection to ' + process.env.MONGOLAB_URI);
var DB = Mongo.connect(process.env.MONGOLAB_URI, ['movies', 'search']);

exports.movies = {};
exports.search = {};

exports.movies.save = function (id, movie) {
    save('movies', id, movie);
};

exports.movies.retrieve = function (id, callback) {
    retrieve('movies', id, callback);
};

exports.search.save = function (query, results) {
    save('search', query, results);
};

exports.search.retrieve = function(query, callback) {
    retrieve('search', query, callback);
};

var save = function (collection, id, data) {
    var createdAt = new Date().getTime();
    var wrapper = { 'id': id, 'data': data, 'createdAt': createdAt };

    DB[collection].save(wrapper, function(err) {
        if (err) {
            console.log('Error persisting data: ' + err);
        }

        DB[collection].find({ 'id': id, 'createdAt': { $ne: createdAt }}).remove(function(err) {
            if (err) {
                console.log('Error removing old data: ' + err);
            }
        });
    });
};

var retrieve = function (collection, id, callback) {
    DB[collection].find({ 'id': id }).sort({ 'createdAt': -1 }).first(function(err, wrapper) {
        if (wrapper) {
            callback(wrapper.data);
        } else {
            callback(undefined);
        }
    });
};

