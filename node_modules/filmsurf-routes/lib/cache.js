var Url = require('url');
var Redis = require('redis');

var connect = function(connectString) {
    console.log('Opening Redis connection to ' + connectString);
    var redisUrl = Url.parse(connectString);
    var client = Redis.createClient(redisUrl.port, redisUrl.hostname);
    client.auth(redisUrl.auth.split(":")[1]);
    return client;
};

var client = connect(process.env.REDISCLOUD_URL);
var active = false;

client.on('connect', function() {
    console.log('Connection to Redis established, waiting for server to be ready');
});

client.on('ready', function() {
    active = true;
    console.log('Successfully connected to Redis');
});

client.on('error', function() {
    active = false;
    console.log('Error connecting to Redis');
});

client.on('end', function() {
    active = false;
    console.log('Connection to Redis ended');
});

exports.save = function(keyArray, value, expiration) {
    if (!active) return;

    var key = keyArray.join(':');

    client.set(key, JSON.stringify(value), function(err) {
        if (err) {
            console.log('Error setting key ' + key + ': ' + err);
        } else {
            client.expire(key, expiration);
        }
    });
};

exports.retrieve = function(keyArray, callback) {
    if (!active) {
        callback(undefined);
        return;
    }

    var key = keyArray.join(':');

    client.get(key, function(err, data) {
        if (err) {
            console.log('Error getting key ' + key + ': ' + err);
            callback(undefined);
        } else if (data) {
            callback(JSON.parse(data));
        } else {
            callback(undefined);
        }
    });
};
